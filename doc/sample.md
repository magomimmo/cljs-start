# cljs-start sample

## Introduction

Even if [cljs-start][1] could be used to create a CLJS lib from scratch,
it could be useful to instrument an existing CLJS lib as well.

In this document we're going to demonstrate how to use `cljs-start`
lein-template with the [hiccups][2] lib which is one of the CLJS lib
which has been included in the [modern-cljs][3] series of tutorials on
[clojurescript][4].

## Fork and clone the original hiccups lib

The first step is to fork and clone the original  `hiccups` lib.

```bash
cd ~/Developer
git clone https://github.com/magomimmo/hiccups.git
cd hiccups
git remote add upstream https://github.com/teropa/hiccups.git
```

> NOTE 1: I always fork the repos I use. Then I always add the
> original repo (upstream) as a remote repo to be ready to be
> collaborative with the authors by eventually submitting push
> requests.

> NOTE 2: I'm assuming that `hiccups` has been cloned in the
> `~/Developer/hiccups` directory.

## Create a new clojurescript lib

The next step is to create a new CLJS lib by using `cljs-start`
somewhere.

```bash
mkdir ~/tmp
cd tmp
lein new cljs-start hiccups
Generating fresh 'lein new' cljs-start project.
cd hiccups
```

## Copy the source from the original repo

Now we have to copy the source code from the original `hiccups` repo
to the newly created one.

Most CLJS libs which define macros puts the corresponding CLJ source
files in the same directory hosting the CLJS source files which is not
wrong at all, but I prefer to adhere to the separation of concerns
principle as much as I can and the `cljs-start` lein-template has been
implemented with this approach.

Here is the directory layout of the original `hiccups` lib:

```bash
tree ~/Developer/hiccups
.
├── LICENSE.html
├── README.md
├── phantom
│   └── unit-test.js
├── project.clj
├── src
│   └── hiccups
│       ├── core.clj
│       ├── runtime.clj
│       └── runtime.cljs
├── test
│   └── hiccups
│       ├── core_test.cljs
│       └── test_macros.clj
└── test-resources
    └── unit-test.html

6 directories, 10 files
```

As you see, all the `hiccups` source files live in the `src/hiccups`
directory. As said, to adhere to the separation of concerns principle
we are going to copy the `clj` source files in the `src/clj` directory
of the newly created `hiccups` project and the `cljs` source files in
the corresponding `src/cljs` directory.

```bash
cd ~/tmp/hiccups
mkdir -p src/clj/hiccups
cp ~/Developer/hiccups/src/hiccups/*.clj src/clj/hiccups/
cp ~/Developer/hiccups/src/hiccups/*.cljs src/cljs/hiccups/
```

Here is the obtained directories layout for the `src` pathname:

```bash
tree src/
src/
├── clj
│   └── hiccups
│       ├── core.clj
│       └── runtime.clj
└── cljs
    └── hiccups
        ├── core.cljs
        └── runtime.cljs

4 directories, 4 files
```

Note that the `cljs-start` lein-template created a `core.cljs` source
file with a dummy content and we have to delete it.

```bash
rm src/cljs/hiccups/core.cljs
```

By having deleted the `core.cljs` file generated by the `cljs-start`
lein-template, we have now to modify the corresponding unit test from
the `test/cljs/hiccups` directory.

```clj
(ns hiccpus.core-test
  (:require-macros [cemerick.cljs.test :as m :refer (deftest testing are is)])
  (:require [cemerick.cljs.test :as t]))

(deftest foo-test
  (is (= true false)))
```

> NOTE 3: Here we defined a failing test just to remember that we have
> to implement the unit tests for the `hiccups` lib.

Here is the complete directories layout of the newly created `hiccups`
lib instrumented by the `cljs-start` lein-template.

```bash
tree
.
├── LICENSE
├── README.md
├── dev-resources
│   ├── public
│   │   ├── index.html
│   │   └── js
│   └── tools
│       ├── http
│       │   └── ring
│       │       └── server.clj
│       └── repl
│           └── brepl
│               └── connect.cljs
├── doc
│   └── intro.md
├── profiles.clj
├── project.clj
├── src
│   ├── clj
│   │   └── hiccups
│   │       ├── core.clj
│   │       └── runtime.clj
│   └── cljs
│       └── hiccups
│           └── runtime.cljs
└── test
    └── cljs
        └── hiccups
            └── core_test.cljs

17 directories, 12 files
```

### Light the fire

Let's see if the newly generated `hiccups` is still compiling.

```bash
lein do compile, test
Compiling ClojureScript.
Compiling "dev-resources/public/js/advanced.js" from ["src/cljs" "test/cljs"]...
Successfully compiled "dev-resources/public/js/advanced.js" in 19.8997 seconds.
Compiling "dev-resources/public/js/simple.js" from ["src/cljs" "test/cljs"]...
Successfully compiled "dev-resources/public/js/simple.js" in 8.564031 seconds.
Compiling "dev-resources/public/js/hiccups.js" from ["src/cljs" "test/cljs" "dev-resources/tools/repl"]...
Successfully compiled "dev-resources/public/js/hiccups.js" in 6.022061 seconds.
Compiling "dev-resources/public/js/useless.js" from ["src/cljs"]...
Successfully compiled "dev-resources/public/js/useless.js" in 4.445521 seconds.
Compiling ClojureScript.

lein test user

Ran 0 tests containing 0 assertions.
0 failures, 0 errors.
Running ClojureScript test: phantomjs-advanced

Testing hiccups.core-test

FAIL in (foo-test) (:)
expected: (= true false)
  actual: (not (= true false))

Ran 1 tests containing 1 assertions.
1 failures, 0 errors.
{:test 1, :pass 0, :fail 1, :error 0, :type :summary}
Running ClojureScript test: phantomjs-simple

Testing hiccups.core-test

FAIL in (foo-test) (:)
expected: (= true false)
  actual: (not (= true false))

Ran 1 tests containing 1 assertions.
1 failures, 0 errors.
{:test 1, :pass 0, :fail 1, :error 0, :type :summary}
Running ClojureScript test: phantomjs-ws

Testing hiccups.core-test

FAIL in (foo-test) (:)
expected: (= true false)
  actual: (not (= true false))

Ran 1 tests containing 1 assertions.
1 failures, 0 errors.
{:test 1, :pass 0, :fail 1, :error 0, :type :summary}
Subprocess failed
```

Not bad. As you see the failing assertions, one for each differently
optimized build, regards the assertion `(= true false)` which is the
one we previously set up as a remembering placeholder.

We now have to adapt the `hiccups` original unit tests to the
`clojurescript.test` plugin.

## Copy the unit test from the original repo

Open the original `core_test.cljs` file and copy all the unit test to
the `core_tes.clj` file in the `hiccups` project created with
`cljs-start`. You also have to adapt the namespace declaration. Here
is the result.

```clj
(ns hiccups.core-test
  (:require-macros [cemerick.cljs.test :as t]
                   [hiccups.core :as hiccups])
  (:require [cemerick.cljs.test :as testing]
            [hiccups.runtime :as hiccupsrt]))

(t/deftest runtime-escaped-chars
  ...)

(t/deftest tag-names
  ...)

(t/deftest tag-contents
 ...
 ; vecs don't expand - error if vec doesn't have tag name
 ; (t/is-thrown (hiccups/html (vector [:p "a"] [:p "b"])))
 ...)

(t/deftest tag-attributes
  ...)

(t/deftest compiled-tags
  ...)

(t/deftest defhtml-macro
  ...)

(t/deftest render-modes
  ...)
```

> NOTE 4: Aside from the namespace declaration which has been adapted
> to the original `hiccups` lib and corresponding unit tests, we only
> commented out the `(t/is-thrown (hiccups/html (vector [:p "a"]
> [:p "b"])))` because the `clojurescript.test` lib does not define
> the `is-thrown` symbol.

### Light the fire

Let's run the `lein do compile, test` chain of tasks.

```bash
lein do clean, compile, test
Deleting files generated by lein-cljsbuild.
Compiling ClojureScript.
Compiling "dev-resources/public/js/advanced.js" from ["src/cljs" "test/cljs"]...
Successfully compiled "dev-resources/public/js/advanced.js" in 18.219907 seconds.
Compiling "dev-resources/public/js/simple.js" from ["src/cljs" "test/cljs"]...
Successfully compiled "dev-resources/public/js/simple.js" in 8.584213 seconds.
Compiling "dev-resources/public/js/hiccups.js" from ["src/cljs" "test/cljs" "dev-resources/tools/repl"]...
Successfully compiled "dev-resources/public/js/hiccups.js" in 6.125027 seconds.
Compiling "dev-resources/public/js/useless.js" from ["src/cljs"]...
Successfully compiled "dev-resources/public/js/useless.js" in 4.902495 seconds.
Compiling ClojureScript.

lein test user

Ran 0 tests containing 0 assertions.
0 failures, 0 errors.
Running ClojureScript test: phantomjs-advanced

Testing hiccups.core-test

Ran 7 tests containing 60 assertions.
0 failures, 0 errors.
{:test 7, :pass 60, :fail 0, :error 0, :type :summary}
Running ClojureScript test: phantomjs-simple

Testing hiccups.core-test

Ran 7 tests containing 60 assertions.
0 failures, 0 errors.
{:test 7, :pass 60, :fail 0, :error 0, :type :summary}
Running ClojureScript test: phantomjs-ws

Testing hiccups.core-test

Ran 7 tests containing 60 assertions.
0 failures, 0 errors.
{:test 7, :pass 60, :fail 0, :error 0, :type :summary}
```

Great. All the 60 assertions from the 7 unit tests passed.

### bREPLing with hiccups

Let's now have some fun by bREPLing with `hiccups`.

```clj
iacomos-MacBook-Pro:hiccups mimmo$ lein repl
Compiling ClojureScript.
nREPL server started on port 54995 on host 127.0.0.1
REPL-y 0.3.0
Clojure 1.5.1
    Docs: (doc function-name-here)
          (find-doc "part-of-name-here")
  Source: (source function-name-here)
 Javadoc: (javadoc java-object-or-class-here)
    Exit: Control+D or (exit) or (quit)
 Results: Stored in vars *1, *2, *3, an exception in *e

user=> (run)
2013-11-25 14:45:04.701:INFO:oejs.Server:jetty-7.6.8.v20121106
2013-11-25 14:45:04.729:INFO:oejs.AbstractConnector:Started SelectChannelConnector@0.0.0.0:3000
#<Server org.eclipse.jetty.server.Server@18ecf9ac>
user=> (browser-repl)
Browser-REPL ready @ http://localhost:55001/8638/repl/start
Type `:cljs/quit` to stop the ClojureScript REPL
nil
cljs.user=>
```

Now visit the [localhost:3000][5] URL and wait for the bREPL
connection to be established.

> NOTE 5: If you use Chrome it should shortly appear a `Waiting for
> localhost` message in the status bar.

```clj
cljs.user=> (ns cljs.user (:require-macros [hiccups.core :as h :refer (html)]))
nil
cljs.user=> (html [:div])
"<div></div>"
cljs.user=> (html [:div#myID [:p.a.b "some text"] [:p.a.b.c "more test"]])
"<div id=\"myID\"><p class=\"a b\">some text</p><p class=\"a b c\">more text</p></div>"
```

Great. It worked like a charm.

Now it's your turn in designing and implementing a great CLJS lib.

[1]: https://github.com/magomimmo/cljs-start
[2]: https://github.com/teropa/hiccups
[3]: https://github.com/magomimmo/modern-cljs/blob/0a6ece9ecebebb675e2b8696092a839d6f33494b/doc/tutorial-09.md#hiccups
[4]: https://github.com/clojure/clojurescript
[5]: http://localhost:3000/
